<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventory & Stock Management</title>
  <link rel="shortcut icon" href="bg_img.PNG" type="image/x-icon">
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bamboo-green: #4a7c59;
      --bamboo-light: #8fbc8f;
      --bamboo-dark: #2d4a35;
      --accent-gold: #ffd700;
      --bg-primary: #f8fffe;
      --shadow-light: 0 4px 20px rgba(74, 124, 89, 0.1);
      --shadow-medium: 0 8px 30px rgba(74, 124, 89, 0.15);
      --gradient-green: linear-gradient(135deg, #4a7c59 0%, #8fbc8f 100%);
    }
    body {
      background: var(--bg-primary);
      font-family: 'Inter', sans-serif;
      color: #2c3e50;
    }
    .dashboard-header {
      background: var(--gradient-green);
      color: white;
      padding: 2rem 0 1rem 0;
      margin-bottom: 2rem;
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-medium);
    }
    .dashboard-header::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M0,0 C20,20 40,0 60,20 C80,40 100,20 100,40 L100,100 L0,100 Z" fill="rgba(255,255,255,0.1)"/></svg>');
      background-size: 100px 100px;
    }
    .dashboard-title {
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      position: relative;
      z-index: 2;
    }
    .dashboard-subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
      position: relative;
      z-index: 2;
    }
    .navbar-brand {
      color: white !important;
      font-weight: 700;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .navbar-brand::before {
      content: "üêº";
      font-size: 2rem;
    }
    .inventory-form {
      background: white;
      border-radius: 20px;
      box-shadow: var(--shadow-light);
      padding: 2rem;
      margin-bottom: 2rem;
      border: 1px solid rgba(74,124,89,0.1);
    }
    .form-label {
      font-weight: 600;
      color: var(--bamboo-dark);
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }
    .form-control, .form-select {
      border-radius: 12px;
      border: 2px solid #e9ecef;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      background-color: #f8f9fa;
      transition: all 0.3s ease;
    }
    .form-control:focus, .form-select:focus {
      border-color: var(--bamboo-green);
      box-shadow: 0 0 0 0.2rem rgba(74,124,89,0.15);
      background-color: white;
    }
    .inventory-table-card {
      background: white;
      border-radius: 20px;
      box-shadow: var(--shadow-light);
      padding: 2rem;
      margin-bottom: 2rem;
      border: 1px solid rgba(74,124,89,0.1);
    }
    .inventory-table {
      border-radius: 12px;
      overflow: hidden;
      background: white;
      box-shadow: var(--shadow-light);
      margin-bottom: 0;
      width: 100%;
    }
    .inventory-table th, .inventory-table td {
      vertical-align: middle;
      font-size: 1rem;
      padding: 0.75rem 1rem;
      transition: background 0.2s, color 0.2s;
    }
    .inventory-table thead {
      background: var(--gradient-green);
      color: white;
      letter-spacing: 1px;
      font-size: 1.05rem;
      border-bottom: 2px solid #8fbc8f;
    }
    .inventory-table tbody tr {
      transition: box-shadow 0.3s, transform 0.2s, background 0.2s;
      animation: fadeInRow 0.7s;
    }
    .inventory-table tbody tr:hover {
      background: rgba(74,124,89,0.07);
      box-shadow: 0 2px 12px rgba(74,124,89,0.08);
      transform: scale(1.01);
    }
    @keyframes fadeInRow {
      from { opacity: 0; transform: translateY(10px);}
      to { opacity: 1; transform: translateY(0);}
    }

    /* Enhanced Add Button */
    .btn-add {
      background: linear-gradient(45deg, #4a7c59 0%, #8fbc8f 50%, #4a7c59 100%);
      background-size: 300% 100%;
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 20px;
      font-weight: 700;
      font-size: 1.1rem;
      position: relative;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 
        0 8px 25px rgba(74, 124, 89, 0.3),
        0 4px 12px rgba(74, 124, 89, 0.2),
        inset 0 1px 0 rgba(255,255,255,0.2);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      width: 100%;
      cursor: pointer;
    }

    .btn-add::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.6s;
    }

    .btn-add:hover {
      background-position: 100% 0;
      transform: translateY(-3px) scale(1.05);
      box-shadow: 
        0 12px 35px rgba(74, 124, 89, 0.4),
        0 6px 20px rgba(74, 124, 89, 0.3),
        inset 0 1px 0 rgba(255,255,255,0.3);
    }

    .btn-add:hover::before {
      left: 100%;
    }

    .btn-add:active {
      transform: translateY(-1px) scale(1.02);
      transition: all 0.1s ease;
    }

    .btn-add:focus {
      outline: none;
      box-shadow: 
        0 12px 35px rgba(74, 124, 89, 0.4),
        0 6px 20px rgba(74, 124, 89, 0.3),
        0 0 0 4px rgba(255, 215, 0, 0.3);
    }

    .btn-add i {
      font-size: 1.4rem;
      transition: transform 0.3s ease;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
    }

    .btn-add:hover i {
      transform: rotate(180deg) scale(1.1);
    }

    .btn-add .btn-text {
      position: relative;
      z-index: 2;
      font-weight: 800;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    /* Update Button */
    .btn-update {
      background: linear-gradient(45deg, #ff8c00 0%, #ffa500 50%, #ff8c00 100%) !important;
      background-size: 300% 100% !important;
    }

    .btn-update:hover {
      background-position: 100% 0 !important;
      box-shadow: 
        0 12px 35px rgba(255, 140, 0, 0.4),
        0 6px 20px rgba(255, 140, 0, 0.3),
        inset 0 1px 0 rgba(255,255,255,0.3) !important;
    }

    /* Loading state */
    .btn-add.loading, .btn-update.loading {
      pointer-events: none;
      opacity: 0.8;
    }

    .btn-add.loading i, .btn-update.loading i {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .btn-delete {
      background: linear-gradient(135deg, #ff5252 0%, #ffbaba 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 0.5rem 1rem;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.2s;
    }
    .btn-delete:hover {
      background: linear-gradient(135deg, #ffbaba 0%, #ff5252 100%);
      color: #fff;
      transform: scale(1.05);
    }

    .btn-edit {
      background: linear-gradient(135deg, #4a90e2 0%, #7bb3f0 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 0.5rem 1rem;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.2s;
    }
    .btn-edit:hover {
      background: linear-gradient(135deg, #7bb3f0 0%, #4a90e2 100%);
      color: #fff;
      transform: scale(1.05);
    }
    .btn-edit:disabled {
      background: #6c757d;
      opacity: 0.6;
      transform: none;
      cursor: not-allowed;
    }

    .status-message {
      margin-top: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 10px;
      font-weight: 500;
      display: none;
    }
    .status-message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status-message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status-message.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    /* Loading overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .loading-spinner {
      background: white;
      padding: 2rem;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .connection-status {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
      z-index: 1000;
    }

    .connection-status.connected {
      background: #28a745;
    }

    .connection-status.disconnected {
      background: #dc3545;
    }

    /* Enhanced modal styles for image viewing */
    .file-modal-image {
      max-width: 100%;
      max-height: 70vh;
      display: block;
      margin: auto;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      transition: transform 0.3s ease;
      cursor: zoom-in;
    }
    
    .file-modal-image:hover {
      transform: scale(1.02);
    }
    
    .file-modal-image.zoomed {
      cursor: zoom-out;
      max-width: none;
      max-height: none;
      width: auto;
      height: auto;
    }
    
    .modal-body.image-container {
      overflow: auto;
      max-height: 80vh;
    }
    
    .file-info {
      background: #f8f9fa;
      padding: 0.75rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      color: #6c757d;
    }

    /* Drag and drop visual feedback */
    .inventory-form.drag-over {
      background: linear-gradient(135deg, rgba(74, 124, 89, 0.1) 0%, rgba(143, 188, 143, 0.1) 100%);
      border: 2px dashed var(--bamboo-green);
      transform: scale(1.02);
    }

    .file-modal-image.loaded {
      animation: fadeInImage 0.3s ease-in;
    }

    @keyframes fadeInImage {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Edit mode styling */
    .inventory-form.edit-mode {
      border: 2px solid #ff8c00;
      background: linear-gradient(135deg, rgba(255, 140, 0, 0.05) 0%, rgba(255, 165, 0, 0.05) 100%);
    }

    .edit-indicator {
      background: #ff8c00;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 1rem;
      display: none;
    }

    .edit-indicator.active {
      display: block;
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
      .dashboard-title { font-size: 1.7rem; }
      .inventory-form, .inventory-table-card { padding: 1.2rem; }
      .form-label { font-size: 1rem; }
    }
    @media (max-width: 992px) {
      .dashboard-title { font-size: 1.4rem; }
      .inventory-form, .inventory-table-card { padding: 1rem; }
      .form-label { font-size: 0.98rem; }
      .btn-add, .btn-update, .btn-delete { font-size: 1rem; padding: 0.7rem 1.2rem; }
    }
    @media (max-width: 768px) {
      .dashboard-title { font-size: 1.1rem; }
      .dashboard-header, .inventory-form, .inventory-table-card { padding: 0.7rem; }
      .inventory-table th, .inventory-table td { font-size: 0.92rem; padding: 0.4rem 0.4rem; }
      .btn-add, .btn-update, .btn-delete { font-size: 0.95rem; padding: 0.6rem 1rem; }
      .file-modal-image { max-height: 40vh; }
      .modal-dialog { max-width: 98vw; margin: 0.5rem auto; }
      .modal-content { border-radius: 10px; }
      .dashboard-header { padding: 1rem 0 0.5rem 0; }
      .dashboard-title, .dashboard-subtitle { text-align: center; }
      .inventory-form, .inventory-table-card { border-radius: 12px; }
      .table-responsive { overflow-x: auto; }
      .form-label { font-size: 0.95rem; }
    }
    @media (max-width: 576px) {
      .dashboard-header, .inventory-form, .inventory-table-card { padding: 0.4rem; }
      .dashboard-title { font-size: 1rem; }
      .dashboard-subtitle { font-size: 0.9rem; }
      .form-label { font-size: 0.9rem; }
      .btn-add, .btn-update, .btn-delete { font-size: 0.9rem; padding: 0.5rem 0.7rem; }
      .file-modal-image { max-height: 30vh; }
      .modal-dialog { max-width: 100vw; margin: 0.2rem auto; }
      .modal-content { border-radius: 6px; }
      .inventory-form, .inventory-table-card { border-radius: 8px; }
      .table-responsive { overflow-x: auto; }
      .inventory-table th, .inventory-table td { font-size: 0.88rem; padding: 0.3rem 0.2rem; }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
      <div class="spinner-border text-primary mb-3" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p>Connecting to database...</p>
    </div>
  </div>

  <!-- Connection Status -->
  <div class="connection-status disconnected" id="connectionStatus">
    <i class="bi bi-wifi-off me-2"></i>Disconnected
  </div>

  <!-- Dashboard Header -->
  <div class="dashboard-header">
    <div class="container">
      <h1 class="navbar-brand">Bamboo Garden</h1>
      <h1 class="dashboard-title">üç≥ Inventory & Stock</h1>
      <p class="dashboard-subtitle">
        Register, monitor and manage all groceries and kitchen stock
      </p>
    </div>
  </div>

  <div class="container">
    <!-- Inventory Form -->
    <div class="inventory-form mb-4" id="inventoryFormContainer">
      <!-- Edit Indicator -->
      <div class="edit-indicator" id="editIndicator">
        <i class="bi bi-pencil me-2"></i>Editing Item - Make changes and click Update
      </div>
      
      <form id="inventoryForm" class="row g-3">
        <div class="col-md-4">
          <label class="form-label" for="itemName"><i class="bi bi-box-seam me-2"></i>Item Name</label>
          <input type="text" class="form-control" id="itemName" placeholder="e.g. Rice, Oil, Chicken" required>
        </div>
        <div class="col-md-3">
          <label class="form-label" for="itemAmount"><i class="bi bi-cash-coin me-2"></i>Amount (<span class="text-muted">&#8377;</span>)</label>
          <div class="input-group">
            <span class="input-group-text">&#8377;</span>
            <input type="number" class="form-control" id="itemAmount" min="0" placeholder="e.g. 10" required>
          </div>
        </div>
        <div class="col-md-4">
          <label class="form-label" for="itemFile"><i class="bi bi-paperclip me-2"></i>Upload Bill/Stock File</label>
          <input type="file" class="form-control" id="itemFile" accept=".txt,.csv,.pdf,.jpg,.jpeg,.png,.webp,.bmp,.gif,.doc,.docx,.xls,.xlsx,.json,.xml,.heic,.tiff" title="Maximum file size: 5MB">
          <div id="itemFileName" class="small mt-1"></div>
          <div class="small text-muted mt-1">
            <i class="bi bi-info-circle me-1"></i>Max: 5MB | Images auto-compress if needed
          </div>
        </div>
        <div class="col-md-1 d-flex align-items-end">
          <button type="submit" class="btn btn-add w-100" id="submitBtn">
            <i class="bi bi-plus-circle"></i>
            <span class="btn-text d-none d-lg-inline">Add Item</span>
            <span class="btn-text d-lg-none">ADD</span>
          </button>
        </div>
      </form>
      
      <!-- Status message -->
      <div class="status-message" id="statusMessage"></div>
    </div>

    <!-- Inventory Table -->
    <div class="inventory-table-card">
      <div class="table-responsive rounded-3">
        <table class="inventory-table table table-bordered align-middle mb-0">
          <thead>
            <tr>
              <th>Item</th>
              <th>Amount (<span class="text-warning">&#8377;</span>)</th>
              <th>File</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="inventoryTableBody">
            <!-- Items will be rendered here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      getDocs, 
      doc, 
      updateDoc, 
      deleteDoc, 
      onSnapshot,
      query,
      orderBy,
      serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase configuration - REPLACE WITH YOUR ACTUAL CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyDY3XhrG-2Cj9y2QvW0RB9afjnW1k-NL6E",
      authDomain: "bamboo-15c88.firebaseapp.com", 
      projectId: "bamboo-15c88",
      storageBucket: "bamboo-15c88.firebasestorage.app",
      messagingSenderId: "491968003258",
      appId: "1:491968003258:web:903605a044306b45745683"
    };

    // Check if Firebase config is properly set
    function isFirebaseConfigValid(config) {
      return config.apiKey && 
             config.authDomain && 
             config.projectId && 
             !config.apiKey.includes('your-') &&
             !config.authDomain.includes('your-') &&
             !config.projectId.includes('your-');
    }

    // Initialize Firebase
    let app, db;
    let currentEditIndex = null;
    let currentItems = [];
    let isFirebaseEnabled = false;

    // Show configuration instructions if needed
    function showConfigInstructions() {
      const instructionsHtml = `
        <div class="alert alert-warning mt-3">
          <h5><i class="bi bi-exclamation-triangle me-2"></i>Firebase Configuration Required</h5>
          <p>To use the database features, please set up Firebase:</p>
          <ol>
            <li>Go to <a href="https://console.firebase.google.com/" target="_blank">Firebase Console</a></li>
            <li>Create a new project or select existing one</li>
            <li>Enable Firestore Database</li>
            <li>Go to Project Settings ‚Üí General ‚Üí Your apps</li>
            <li>Copy the config and replace the placeholder values in the code</li>
          </ol>
          <p class="mb-0"><strong>Currently running in demo mode without persistence.</strong></p>
        </div>
      `;
      $('#inventoryFormContainer').after(instructionsHtml);
    }

    async function initializeFirebase() {
      try {
        if (!isFirebaseConfigValid(firebaseConfig)) {
          console.warn('Firebase config not properly set. Running in demo mode.');
          updateConnectionStatus(false);
          hideLoadingOverlay();
          showConfigInstructions();
          showStatusMessage('Running in demo mode. Data will not persist.', 'info');
          // Initialize with empty data for demo
          renderInventoryTable();
          return;
        }

        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        isFirebaseEnabled = true;
        
        // Test connection by trying to read from Firestore
        await setupRealtimeListener();
        
        // Show connected status
        updateConnectionStatus(true);
        hideLoadingOverlay();
        showStatusMessage('Connected to Firebase database successfully!', 'success');
        
      } catch (error) {
        console.error('Firebase initialization error:', error);
        isFirebaseEnabled = false;
        updateConnectionStatus(false);
        hideLoadingOverlay();
        
        if (error.code === 'permission-denied') {
          showStatusMessage('Database access denied. Please check Firestore security rules.', 'error');
        } else if (error.code === 'unavailable') {
          showStatusMessage('Database temporarily unavailable. Please try again later.', 'error');
        } else {
          showStatusMessage('Failed to connect to database: ' + error.message, 'error');
        }
        
        showConfigInstructions();
        // Fallback to demo mode
        renderInventoryTable();
      }
    }

    // Database operations
    async function addInventoryItem(name, amount, fileData, fileName, fileType) {
      if (!isFirebaseEnabled) {
        // Demo mode - just add to local array
        const newItem = {
          id: 'demo_' + Date.now(),
          name: name,
          amount: amount,
          fileData: fileData || null,
          fileName: fileName || null,
          fileType: fileType || null,
          createdAt: new Date(),
          updatedAt: new Date()
        };
        currentItems.unshift(newItem);
        renderInventoryTable();
        showStatusMessage('Item added (demo mode - not saved to database)', 'info');
        return newItem.id;
      }

      try {
        showLoadingOverlay('Adding item...');
        
        const docRef = await addDoc(collection(db, 'inventory'), {
          name: name,
          amount: amount,
          fileData: fileData || null,
          fileName: fileName || null,
          fileType: fileType || null,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        
        hideLoadingOverlay();
        showStatusMessage('Item added successfully!', 'success');
        return docRef.id;
        
      } catch (error) {
        hideLoadingOverlay();
        console.error('Error adding item:', error);
        showStatusMessage('Error adding item: ' + error.message, 'error');
        throw error;
      }
    }

    async function updateInventoryItem(docId, name, amount, fileData, fileName, fileType) {
      if (!isFirebaseEnabled) {
        // Demo mode - update local array
        const itemIndex = currentItems.findIndex(item => item.id === docId);
        if (itemIndex !== -1) {
          const updateData = {
            name: name,
            amount: amount,
            updatedAt: new Date()
          };

          if (fileData !== undefined) {
            updateData.fileData = fileData;
            updateData.fileName = fileName;
            updateData.fileType = fileType;
          }

          currentItems[itemIndex] = { ...currentItems[itemIndex], ...updateData };
          renderInventoryTable();
          showStatusMessage('Item updated (demo mode - not saved to database)', 'info');
        }
        return;
      }

      try {
        showLoadingOverlay('Updating item...');
        
        const updateData = {
          name: name,
          amount: amount,
          updatedAt: serverTimestamp()
        };

        // Only update file data if new file is provided
        if (fileData !== undefined) {
          updateData.fileData = fileData;
          updateData.fileName = fileName;
          updateData.fileType = fileType;
        }

        await updateDoc(doc(db, 'inventory', docId), updateData);
        
        hideLoadingOverlay();
        showStatusMessage('Item updated successfully!', 'success');
        
      } catch (error) {
        hideLoadingOverlay();
        console.error('Error updating item:', error);
        showStatusMessage('Error updating item: ' + error.message, 'error');
        throw error;
      }
    }

    async function deleteInventoryItem(docId) {
      if (!isFirebaseEnabled) {
        // Demo mode - remove from local array
        const itemIndex = currentItems.findIndex(item => item.id === docId);
        if (itemIndex !== -1) {
          currentItems.splice(itemIndex, 1);
          renderInventoryTable();
          showStatusMessage('Item deleted (demo mode - not saved to database)', 'info');
        }
        return;
      }

      try {
        showLoadingOverlay('Deleting item...');
        
        await deleteDoc(doc(db, 'inventory', docId));
        
        hideLoadingOverlay();
        showStatusMessage('Item deleted successfully!', 'success');
        
      } catch (error) {
        hideLoadingOverlay();
        console.error('Error deleting item:', error);
        showStatusMessage('Error deleting item: ' + error.message, 'error');
        throw error;
      }
    }

    async function setupRealtimeListener() {
      if (!isFirebaseEnabled) {
        return;
      }

      try {
        const q = query(collection(db, 'inventory'), orderBy('createdAt', 'desc'));
        
        onSnapshot(q, (querySnapshot) => {
          currentItems = [];
          querySnapshot.forEach((doc) => {
            currentItems.push({
              id: doc.id,
              ...doc.data()
            });
          });
          renderInventoryTable();
        }, (error) => {
          console.error('Error listening to inventory changes:', error);
          updateConnectionStatus(false);
          showStatusMessage('Connection to database lost. Please refresh the page.', 'error');
        });
        
      } catch (error) {
        console.error('Error setting up listener:', error);
        updateConnectionStatus(false);
        throw error;
      }
    }

    function renderInventoryTable() {
      const tbody = $('#inventoryTableBody');
      
      if (currentItems.length === 0) {
        tbody.html(`<tr><td colspan="4" class="text-center text-muted">No items registered yet.</td></tr>`);
        return;
      }
      
      tbody.html(currentItems.map((item, idx) => `
        <tr class="animate__animated animate__fadeInUp ${item.id === currentEditIndex ? 'table-warning' : ''}">
          <td>${escapeHtml(item.name)}</td>
          <td><span class="fw-bold">&#8377; ${parseFloat(item.amount).toLocaleString('en-IN')}</span></td>
          <td>
            ${item.fileData && item.fileName
              ? `<button type="button" class="btn btn-sm btn-outline-primary" title="View File" onclick="viewInventoryFile('${item.id}')">
                  <i class="bi bi-eye"></i> View
                </button>`
              : '<span class="text-muted">No file</span>'
            }
          </td>
          <td>
            <button class="btn btn-edit btn-sm me-1" onclick="editInventoryItem('${item.id}')" title="Edit" ${item.id === currentEditIndex ? 'disabled' : ''}>
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-delete btn-sm" onclick="confirmDeleteItem('${item.id}')" title="Delete">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `).join(''));
    }

    // UI helper functions
    function showLoadingOverlay(message = 'Loading...') {
      $('#loadingOverlay p').text(message);
      $('#loadingOverlay').show();
    }

    function hideLoadingOverlay() {
      $('#loadingOverlay').hide();
    }

    function updateConnectionStatus(connected) {
      const $status = $('#connectionStatus');
      if (connected) {
        $status.removeClass('disconnected').addClass('connected');
        $status.html('<i class="bi bi-wifi me-2"></i>Connected');
      } else {
        $status.removeClass('connected').addClass('disconnected');
        $status.html('<i class="bi bi-wifi-off me-2"></i>Disconnected');
      }
    }

    function showStatusMessage(message, type) {
      const $statusMessage = $('#statusMessage');
      $statusMessage.removeClass('success error info').addClass(type);
      $statusMessage.text(message).show();
      setTimeout(() => {
        $statusMessage.hide();
      }, 5000);
    }

    // File handling utilities
    const MAX_FILE_SIZE = 800 * 1024; // 800KB to leave room for other data in Firestore
    const MAX_UPLOAD_SIZE = 5 * 1024 * 1024; // 5MB maximum upload size
    const MAX_IMAGE_DIMENSION = 800; // Reduced max dimension for better compression

    function compressImage(file, targetSizeKB = 700, maxAttempts = 5) {
      return new Promise((resolve, reject) => {
        if (!file.type.startsWith('image/')) {
          resolve(file);
          return;
        }

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();

        img.onload = function() {
          try {
            let { width, height } = img;
            let quality = 0.8;
            let scaleFactor = 1;
            
            // Calculate aggressive scaling for large images
            const maxDimension = Math.max(width, height);
            if (maxDimension > MAX_IMAGE_DIMENSION) {
              scaleFactor = MAX_IMAGE_DIMENSION / maxDimension;
            }
            
            // Further reduce for very large files
            if (file.size > 2 * 1024 * 1024) { // If > 2MB
              scaleFactor = Math.min(scaleFactor, 0.5); // Scale down to 50%
            } else if (file.size > 1024 * 1024) { // If > 1MB
              scaleFactor = Math.min(scaleFactor, 0.7); // Scale down to 70%
            }

            width = Math.max(1, Math.floor(width * scaleFactor));
            height = Math.max(1, Math.floor(height * scaleFactor));

            canvas.width = width;
            canvas.height = height;
            
            function attemptCompression(currentQuality, attempt = 1) {
              ctx.clearRect(0, 0, width, height);
              ctx.drawImage(img, 0, 0, width, height);
              
              // Force JPEG for better compression
              const outputFormat = 'image/jpeg';
              
              canvas.toBlob((blob) => {
                if (!blob) {
                  if (attempt < maxAttempts) {
                    // Try with even more aggressive settings
                    width = Math.max(1, Math.floor(width * 0.8));
                    height = Math.max(1, Math.floor(height * 0.8));
                    canvas.width = width;
                    canvas.height = height;
                    attemptCompression(currentQuality * 0.7, attempt + 1);
                  } else {
                    reject(new Error('Failed to create compressed image blob after multiple attempts'));
                  }
                  return;
                }

                console.log(`Compression attempt ${attempt}: ${formatFileSize(blob.size)} (quality: ${currentQuality.toFixed(2)})`);

                if (blob.size <= targetSizeKB * 1024) {
                  resolve(blob);
                } else if (attempt < maxAttempts && currentQuality > 0.1) {
                  // Try with lower quality and smaller dimensions
                  const newQuality = Math.max(0.1, currentQuality * 0.6);
                  width = Math.max(1, Math.floor(width * 0.9));
                  height = Math.max(1, Math.floor(height * 0.9));
                  canvas.width = width;
                  canvas.height = height;
                  attemptCompression(newQuality, attempt + 1);
                } else {
                  reject(new Error(`Unable to compress image below ${targetSizeKB}KB after ${maxAttempts} attempts. Final size: ${formatFileSize(blob.size)}`));
                }
              }, outputFormat, currentQuality);
            }

            attemptCompression(quality);

          } catch (error) {
            reject(new Error('Image processing failed: ' + error.message));
          }
        };

        img.onerror = () => reject(new Error('Failed to load image for compression'));
        
        try {
          img.src = URL.createObjectURL(file);
        } catch (error) {
          reject(new Error('Failed to create image URL: ' + error.message));
        }
      });
    }

    function validateFileSize(fileData) {
      // Calculate actual base64 size
      const actualSize = new Blob([fileData]).size;
      console.log(`Base64 data size: ${formatFileSize(actualSize)}`);
      return actualSize <= MAX_FILE_SIZE;
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    async function processFile(file) {
      if (!file) return null;

      console.log(`Processing file: ${file.name}, Size: ${formatFileSize(file.size)}, Type: ${file.type}`);

      // Check maximum upload size (5MB)
      if (file.size > MAX_UPLOAD_SIZE) {
        throw new Error(`File size (${formatFileSize(file.size)}) exceeds maximum limit of 5MB. Please choose a smaller file.`);
      }

      let processedFile = file;

      // Handle images that are larger than Firestore limit
      if (file.type.startsWith('image/') && file.size > MAX_FILE_SIZE) {
        showStatusMessage(`Compressing large image (${formatFileSize(file.size)})...`, 'info');
        
        try {
          processedFile = await compressImage(file, 600); // Target 600KB to be safe
          showStatusMessage(`Image compressed to ${formatFileSize(processedFile.size)}`, 'success');
          console.log(`Compression successful: ${formatFileSize(file.size)} ‚Üí ${formatFileSize(processedFile.size)}`);
        } catch (error) {
          console.error('Compression failed:', error);
          
          // Offer simple resize option
          const tryResize = confirm(
            `Advanced compression failed: ${error.message}\n\n` +
            `Would you like to try a simple resize (may lose quality)?`
          );
          
          if (tryResize) {
            try {
              processedFile = await compressImage(file, 500, 1); // Single attempt with very aggressive settings
              showStatusMessage(`Image resized to ${formatFileSize(processedFile.size)}`, 'success');
            } catch (resizeError) {
              throw new Error(`Both compression and resize failed. Please choose a smaller image file (under 800KB).`);
            }
          } else {
            throw new Error('Upload cancelled. Please choose a smaller image file.');
          }
        }
      }

      // For non-image files larger than 800KB, warn user but allow upload
      if (!file.type.startsWith('image/') && file.size > MAX_FILE_SIZE) {
        const proceed = confirm(
          `File size is ${formatFileSize(file.size)}. Large files will likely fail to upload.\n\n` +
          `Would you like to continue anyway?`
        );
        if (!proceed) {
          throw new Error('Upload cancelled by user');
        }
      }

      // Convert to base64
      const reader = new FileReader();
      return new Promise((resolve, reject) => {
        reader.onload = function(evt) {
          const fileData = evt.target.result;
          
          // Final size check for Firestore compatibility
          if (!validateFileSize(fileData)) {
            const sizeAfterBase64 = new Blob([fileData]).size;
            reject(new Error(
              `File is still too large for database storage (${formatFileSize(sizeAfterBase64)}).\n\n` +
              `Database limit is 800KB. Please choose a smaller file.`
            ));
            return;
          }
          
          resolve({
            data: fileData,
            name: file.name,
            type: file.type,
            size: processedFile.size,
            originalSize: file.size
          });
        };
        
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(processedFile);
      });
    }

    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
    }
    window.viewInventoryFile = function(itemId) {
      const item = currentItems.find(i => i.id === itemId);
      
      if (!item) {
        alert('Item not found.');
        return;
      }
      
      if (!item.fileData) {
        alert('No file data available for this item.');
        return;
      }

      const fileName = item.fileName || 'Unknown File';
      const mimeMatch = item.fileData.match(/^data:([^;]+);/);
      const mimeType = mimeMatch ? mimeMatch[1] : '';
      
      if (mimeType.startsWith('image/')) {
        showImageModal(item.fileData, fileName, mimeType);
      } else if (mimeType === 'application/pdf') {
        showPdfModal(item.fileData, fileName);
      } else if (mimeType.startsWith('text/')) {
        showTextModal(item.fileData, fileName);
      } else {
        downloadFile(item.fileData, fileName);
      }
    };

    window.editInventoryItem = function(itemId) {
      const item = currentItems.find(i => i.id === itemId);
      if (!item) return;

      // Set edit mode
      currentEditIndex = itemId;
      
      // Fill form with item data
      $('#itemName').val(item.name);
      $('#itemAmount').val(item.amount);
      $('#itemFileName').text(item.fileName || '');
      
      // File input is optional in edit mode
      $('#itemFile').prop('required', false);

      // Update UI for edit mode
      enterEditMode();

      // Scroll to form and focus
      $('html, body').animate({ 
        scrollTop: $('#inventoryFormContainer').offset().top - 20 
      }, 300);
      $('#itemName').focus();
    };

    window.confirmDeleteItem = function(itemId) {
      if (confirm('Are you sure you want to delete this item?')) {
        deleteInventoryItem(itemId);
        
        // If we're editing the deleted item, cancel edit mode
        if (currentEditIndex === itemId) {
          cancelEditMode();
        }
      }
    };

    window.cancelEditMode = function() {
      exitEditMode();
      showStatusMessage('Edit cancelled', 'info');
    };

    // Edit mode functions
    function enterEditMode() {
      const $container = $('#inventoryFormContainer');
      const $submitBtn = $('#submitBtn');
      const $editIndicator = $('#editIndicator');
      
      // Update form styling
      $container.addClass('edit-mode');
      $editIndicator.addClass('active');
      
      // Update button text and styling
      $submitBtn.removeClass('btn-add').addClass('btn-update');
      $submitBtn.find('i').attr('class', 'bi bi-arrow-repeat');
      
      // Update button text for both desktop and mobile
      $submitBtn.find('.btn-text.d-none.d-lg-inline').text('Update Item');
      $submitBtn.find('.btn-text.d-lg-none').text('UPDATE');
      
      // Add cancel button
      addCancelButton();
      
      // Re-render table to highlight editing row
      renderInventoryTable();
    }

    function exitEditMode() {
      const $container = $('#inventoryFormContainer');
      const $submitBtn = $('#submitBtn');
      const $editIndicator = $('#editIndicator');
      
      // Reset edit state
      currentEditIndex = null;
      
      // Update form styling
      $container.removeClass('edit-mode');
      $editIndicator.removeClass('active');
      
      // Reset button styling and text
      $submitBtn.removeClass('btn-update').addClass('btn-add');
      $submitBtn.find('i').attr('class', 'bi bi-plus-circle');
      
      // Reset button text for both desktop and mobile
      $submitBtn.find('.btn-text.d-none.d-lg-inline').text('Add Item');
      $submitBtn.find('.btn-text.d-lg-none').text('ADD');
      
      // Reset form
      $('#inventoryForm')[0].reset();
      $('#itemFileName').text('');
      $('#itemFile').prop('required', true);
      
      // Remove cancel button
      removeCancelButton();
      
      // Re-render table
      renderInventoryTable();
    }

    function addCancelButton() {
      if ($('#cancelEditBtn').length === 0) {
        const cancelBtn = `
          <div class="col-12 mt-2">
            <button type="button" class="btn btn-outline-secondary" id="cancelEditBtn" onclick="cancelEditMode()">
              <i class="bi bi-x-circle me-2"></i>Cancel Edit
            </button>
          </div>
        `;
        $('#inventoryForm .row').append(cancelBtn);
      }
    }

    function removeCancelButton() {
      $('#cancelEditBtn').parent().remove();
    }

    // File modal functions
    function showImageModal(fileData, fileName, fileType) {
      if (!/^data:image\//.test(fileData)) {
        alert('Invalid image data format.');
        return;
      }

      const imageHtml = `
        <div class="file-info">
          <strong>File:</strong> ${escapeHtml(fileName)}<br>
          <strong>Type:</strong> ${escapeHtml(fileType)}<br>
          <strong>Click image to zoom</strong>
        </div>
        <div style="text-align: center;">
          <img src="${fileData}" 
               alt="${escapeHtml(fileName)}" 
               class="file-modal-image"
               onload="handleImageLoad(this)"
               onerror="handleImageError(this)"
               onclick="toggleImageZoom(this)">
        </div>
      `;
      
      showFileModal(imageHtml, fileName, 'image-container');
    }

    function showPdfModal(fileData, fileName) {
      const pdfHtml = `
        <div class="file-info">
          <strong>File:</strong> ${escapeHtml(fileName)}<br>
          <strong>Type:</strong> PDF Document
        </div>
        <iframe src="${fileData}" 
                style="width:100%;height:70vh;border:none;border-radius:8px;"
                title="${escapeHtml(fileName)}">
          <p>Your browser doesn't support PDFs. 
             <a href="${fileData}" download="${fileName}">Download the PDF</a> instead.</p>
        </iframe>
      `;
      
      showFileModal(pdfHtml, fileName);
    }

    function showTextModal(fileData, fileName) {
      let textContent = '';
      try {
        if (fileData.startsWith('data:text/')) {
          const base64Data = fileData.split(',')[1];
          textContent = atob(base64Data);
        } else {
          textContent = 'Unable to display text content.';
        }
      } catch (error) {
        textContent = 'Error reading text file.';
      }

      const textHtml = `
        <div class="file-info">
          <strong>File:</strong> ${escapeHtml(fileName)}<br>
          <strong>Type:</strong> Text Document
        </div>
        <pre style="max-height:60vh;overflow:auto;background:#f8f9fa;padding:1rem;border-radius:8px;font-size:0.9rem;">${escapeHtml(textContent)}</pre>
      `;
      
      showFileModal(textHtml, fileName);
    }

    function downloadFile(fileData, fileName) {
      try {
        const link = document.createElement('a');
        link.href = fileData;
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (error) {
        alert('Error downloading file: ' + error.message);
      }
    }

    function showFileModal(contentHtml, title, extraClass = '') {
      // Remove existing modal
      $('#fileViewModal').remove();
      
      const modalHtml = `
        <div class="modal fade" id="fileViewModal" tabindex="-1">
          <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">${escapeHtml(title)}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body ${extraClass}" style="overflow:auto;">
                ${contentHtml}
              </div>
            </div>
          </div>
        </div>
      `;
      
      $('body').append(modalHtml);
      const modal = new bootstrap.Modal(document.getElementById('fileViewModal'));
      modal.show();
      
      // Clean up when modal is hidden
      $('#fileViewModal').on('hidden.bs.modal', function() {
        $('#fileViewModal').remove();
      });
    }

    // Image handling functions
    window.handleImageError = function(img) {
      img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjhmOWZhIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzZjNzU3ZCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIG5vdCBmb3VuZDwvdGV4dD48L3N2Zz4=';
      img.onerror = null;
    };

    window.handleImageLoad = function(img) {
      img.classList.add('loaded');
    };

    window.toggleImageZoom = function(img) {
      img.classList.toggle('zoomed');
    };

    // Document ready function
    $(document).ready(function() {
      // Show selected file name and size info
      $('#itemFile').on('change', function() {
        const file = this.files[0];
        if (file) {
          const sizeFormatted = formatFileSize(file.size);
          let sizeInfo = ` (${sizeFormatted})`;
          let className = 'text-muted';
          
          // Color coding and warnings based on file size
          if (file.size > MAX_UPLOAD_SIZE) {
            sizeInfo += ' - ‚ö†Ô∏è Too large!';
            className = 'text-danger';
          } else if (file.size > MAX_FILE_SIZE) {
            if (file.type.startsWith('image/')) {
              sizeInfo += ' - üîÑ Will be compressed';
              className = 'text-warning';
            } else {
              sizeInfo += ' - ‚ö†Ô∏è Large file';
              className = 'text-warning';
            }
          } else {
            sizeInfo += ' - ‚úÖ Good size';
            className = 'text-success';
          }
          
          $('#itemFileName').html(`${file.name}<span class="${className}">${sizeInfo}</span>`);
        } else {
          $('#itemFileName').text('');
        }
      });

      // Form submission handler
      $('#inventoryForm').on('submit', async function(e) {
        e.preventDefault();
        
        const $submitBtn = $('#submitBtn');
        const $icon = $submitBtn.find('i');
        const originalIcon = $icon.attr('class');
        
        // Show loading state
        $submitBtn.addClass('loading');
        $icon.attr('class', 'bi bi-arrow-clockwise');

        const name = $('#itemName').val().trim();
        const amount = parseFloat($('#itemAmount').val());
        const fileInput = $('#itemFile')[0];
        const file = fileInput.files[0];

        // Validation
        if (!name || isNaN(amount) || amount < 0) {
          alert('Please enter valid item details.');
          resetButtonState();
          return;
        }

        // Check if file is required (not in edit mode or no existing file)
        if (currentEditIndex === null && !file) {
          alert('Please upload a file.');
          resetButtonState();
          return;
        }

        function resetButtonState() {
          $submitBtn.removeClass('loading');
          $icon.attr('class', originalIcon);
        }

        async function handleSuccess(fileData, fileName, fileType) {
          const $submitBtn = $('#submitBtn');
          
          try {
            if (currentEditIndex !== null) {
              // Update existing item
              await updateInventoryItem(currentEditIndex, name, amount, fileData, fileName, fileType);
              
              // Show temporary success text
              $submitBtn.find('.btn-text.d-none.d-lg-inline').text('Updated!');
              $submitBtn.find('.btn-text.d-lg-none').text('UPDATED!');
              
              setTimeout(() => {
                exitEditMode(); // This will reset button text back to "Add Item"
              }, 1000);
              
            } else {
              // Add new item
              await addInventoryItem(name, amount, fileData, fileName, fileType);
              $('#inventoryForm')[0].reset();
              $('#itemFileName').text('');
              
              // Show temporary success text
              $submitBtn.find('.btn-text.d-none.d-lg-inline').text('Added!');
              $submitBtn.find('.btn-text.d-lg-none').text('ADDED!');
              
              setTimeout(() => {
                $submitBtn.find('.btn-text.d-none.d-lg-inline').text('Add Item');
                $submitBtn.find('.btn-text.d-lg-none').text('ADD');
              }, 1000);
            }
            
            resetButtonState();
            
          } catch (error) {
            resetButtonState();
          }
        }

        if (file) {
          // Process file with compression and validation
          try {
            const processedFile = await processFile(file);
            await handleSuccess(processedFile.data, processedFile.name, processedFile.type);
          } catch (error) {
            alert('File processing error: ' + error.message);
            resetButtonState();
          }
        } else {
          // No new file (edit mode only)
          await handleSuccess();
        }
      });

      // Drag and drop functionality
      const $formContainer = $('#inventoryFormContainer');
      
      $formContainer.on('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        $(this).addClass('drag-over');
      });
      
      $formContainer.on('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        $(this).removeClass('drag-over');
      });
      
      $formContainer.on('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        $(this).removeClass('drag-over');
        
        const files = e.originalEvent.dataTransfer.files;
        if (files.length > 0) {
          $('#itemFile')[0].files = files;
          $('#itemFile').trigger('change');
        }
      });
    });

    // Keyboard shortcuts
    $(document).on('keydown', function(e) {
      // Ctrl/Cmd + U for upload
      if ((e.ctrlKey || e.metaKey) && e.key === 'u') {
        e.preventDefault();
        $('#itemFile').click();
      }
      
      // Ctrl/Cmd + N for new item (focus on name input)
      if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        if (currentEditIndex !== null) {
          cancelEditMode();
        }
        $('#itemName').focus();
      }
      
      // Escape to cancel edit mode or close modal
      if (e.key === 'Escape') {
        const modal = bootstrap.Modal.getInstance(document.getElementById('fileViewModal'));
        if (modal) {
          modal.hide();
        } else if (currentEditIndex !== null) {
          cancelEditMode();
        }
      }
    });

    // Initial setup - Initialize Firebase when page loads
    showLoadingOverlay('Connecting to database...');
    initializeFirebase();

  </script>
</body>
</html>
